{% for service in ["lms", "cms"] %}
{% set exclude = "lms" if service == "cms" else "cms" %}
{% set service_variants = iter_celery_workers_config().get(service) %}
{% set config = service_variants.get("default", {}) %}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{service}}-worker
spec:
  template:
    spec:
      containers:
        - name: {{service}}-worker
          args:
            - "celery"
            - "--app={{service}}.celery"
            - "worker"
            - "--loglevel=info"
            - "--hostname=edx.{{service}}.core.default.%%h"
            - "--max-tasks-per-child=100"
            {% if config and service_variants.keys()|length > 1 %}
            - "--queues=edx.{{service}}.core.default"
            {% else %}
            "--exclude-queues=edx.{{exclude}}.core.default"
            {% endif %}
{% endfor %}
